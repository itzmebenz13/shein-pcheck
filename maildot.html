<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MailDot Gen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta name="theme-color" content="#ffffff">

    <!-- Theme Init (No Flash) -->
    <script>
        if (localStorage.getItem('shein_pcal_theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Roboto+Mono:wght@400;500&display=swap');

        /* Defaults */
        body { font-family: 'Inter', sans-serif; background-color: #f6f6f6; transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        /* Dark Mode */
        html.dark-mode body { background-color: #121212; color: #ffffff; }
        html.dark-mode .bg-white { background-color: #1e1e1e !important; color: #ffffff !important; border-color: #333 !important; }
        html.dark-mode .bg-gray-50, html.dark-mode .bg-gray-100 { background-color: #181818 !important; color: #e5e5e5 !important; border-color: #333 !important; }
        html.dark-mode .text-gray-600, html.dark-mode .text-gray-500, html.dark-mode .text-gray-400 { color: #a3a3a3 !important; }
        html.dark-mode .text-black, html.dark-mode .text-gray-800 { color: #ffffff !important; }
        html.dark-mode input, html.dark-mode select { background-color: transparent; color: white; border-color: #444; }
        html.dark-mode .border-gray-200, html.dark-mode .border-gray-300, html.dark-mode .border-gray-100 { border-color: #333 !important; }
        html.dark-mode .stat-card { background-color: #1e1e1e; border-color: #333; }
        html.dark-mode textarea { background-color: #262626; color: white; border-color: #444; }
        
        /* Dark Mode Red Button Fixes */
        html.dark-mode .border-red-200 { border-color: #7f1d1d !important; }
        html.dark-mode .hover\:bg-red-50:hover { background-color: #450a0a !important; }

        /* Custom Inputs */
        .md-input {
            width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px;
            font-size: 14px; outline: none; transition: border-color 0.2s;
        }
        .md-input:focus { border-color: #000; }
        html.dark-mode .md-input:focus { border-color: #fff; }

        /* Email Item */
        .email-item {
            display: flex; flex-direction: column; gap: 8px;
            padding: 12px; background: white; border-radius: 8px;
            border: 1px solid #e5e7eb; margin-bottom: 8px;
            transition: all 0.2s;
        }
        
        /* Dark Mode Fix for Email Item Background */
        html.dark-mode .email-item {
            background-color: #1e1e1e;
            border-color: #333;
        }

        .email-row {
            display: flex; justify-content: space-between; align-items: center;
        }

        .email-text {
            font-family: 'Roboto Mono', monospace; font-size: 13px; font-weight: 500;
            word-break: break-all; color: #333;
            padding: 4px 0; display: block; flex: 1; transition: color 0.2s;
        }
        html.dark-mode .email-text { color: #e5e5e5; }
        
        /* State Colors */
        .email-text.copied { color: #16a34a !important; } /* Green when copied */
        .email-text.sold { color: #ef4444 !important; text-decoration: line-through; opacity: 0.8; } /* Red when sold */

        .copy-btn-icon {
            padding: 4px 8px; color: #9ca3af; font-size: 14px;
            cursor: pointer; transition: color 0.2s;
        }
        .copy-btn-icon:hover { color: #2563eb; }
        html.dark-mode .copy-btn-icon:hover { color: #60a5fa; }
        
        /* Locked Icon */
        .copy-btn-icon.locked { cursor: not-allowed; color: #ef4444 !important; }

        /* Controls Row */
        .item-controls { display: flex; gap: 8px; align-items: center; }
        .tiny-input {
            padding: 6px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 11px;
            width: 80px; background: transparent;
        }
        
        /* Status Toggle */
        .status-btn {
            font-size: 10px; font-weight: 800; padding: 4px 0; border-radius: 4px;
            text-transform: uppercase; cursor: pointer; border: 1px solid;
            width: 60px; text-align: center; flex-shrink: 0;
        }
        .status-unused { background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db; }
        .status-active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .status-sold { background-color: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
        
        html.dark-mode .status-unused { background-color: #374151; color: #9ca3af; border-color: #4b5563; }
        html.dark-mode .status-active { background-color: #172554; color: #93c5fd; border-color: #1e3a8a; }
        html.dark-mode .status-sold { background-color: #052e16; color: #86efac; border-color: #14532d; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
        .stat-card { background: white; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb; position: relative; }
        .stat-val { font-size: 18px; font-weight: 900; }
        .stat-lbl { font-size: 10px; text-transform: uppercase; color: #6b7280; font-weight: 600; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-card {
            background: white; width: 90%; max-width: 320px; border-radius: 12px;
            padding: 20px; transform: translateY(20px); transition: transform 0.2s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-overlay.show .modal-card { transform: translateY(0); }
        
        /* Dark Mode Modal Fix */
        html.dark-mode .modal-card {
            background-color: #1e1e1e;
            color: #ffffff;
            border: 1px solid #333;
        }

        /* Saved Email Item */
        .saved-email-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer;
        }
        .saved-email-row:hover { background-color: #f9fafb; }
        html.dark-mode .saved-email-row { border-color: #333; }
        html.dark-mode .saved-email-row:hover { background-color: #262626; }

        /* Number Badge */
        .row-number {
            font-size: 10px; color: #9ca3af; font-family: monospace;
            min-width: 24px; text-align: right; margin-right: 8px;
            user-select: none;
        }
        
        /* Batch Input */
        .batch-container {
            background: white; border: 1px solid #e5e7eb; border-radius: 8px;
            padding: 8px; margin-bottom: 12px; display: flex; gap: 8px; align-items: center;
        }
        html.dark-mode .batch-container { background-color: #1e1e1e; border-color: #333; }
    </style>
</head>
<body class="min-h-screen pb-24"> <!-- Added padding bottom for fixed elements if needed -->

    <div class="max-w-md mx-auto bg-gray-50 min-h-screen relative shadow-2xl">
        
        <!-- Header -->
        <header class="bg-white sticky top-0 z-50 px-4 py-3 shadow-sm flex items-center justify-between border-b border-gray-100">
            <div class="flex items-center gap-2">
                <a href="index.html" class="text-xl text-gray-800"><i class="fas fa-chevron-left"></i></a>
                <h1 class="text-lg font-black italic tracking-tighter">Mail<span class="text-blue-600">Dot</span></h1>
            </div>
            <div class="flex items-center gap-4">
                <button class="text-gray-600 hover:text-blue-600 transition-colors" id="btn-data" title="Backup/Restore">
                    <i class="fas fa-database"></i>
                </button>
                <button class="text-gray-600 hover:text-black transition-colors" id="btn-theme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main class="p-4">
            
            <!-- Dashboard Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Today's Earnings</div>
                    <div class="stat-val text-green-600" id="stat-today">₱0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Accounts Made</div>
                    <div class="stat-val text-blue-600" id="stat-accounts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">This Week</div>
                    <div class="stat-val" id="stat-week">₱0.00</div>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-start">
                        <div class="stat-lbl">All Time</div>
                        <!-- VISIBLE RESET BUTTON -->
                        <button onclick="resetData()" class="text-gray-300 hover:text-red-500 transition-colors px-1 -mt-1 -mr-1" title="Reset Data">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                    <div class="stat-val" id="stat-total">₱0.00</div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Email Address</label>
                
                <div class="flex gap-2 mb-3">
                    <div class="relative flex-1">
                        <input type="email" id="input-email" class="md-input w-full pr-10" placeholder="example@gmail.com">
                        <button id="btn-open-storage" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 p-2" title="Saved Emails">
                            <i class="fas fa-folder"></i>
                        </button>
                    </div>
                    <button id="btn-save-email" class="bg-gray-100 text-gray-600 border border-gray-200 rounded-lg px-3 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-100 transition-colors" title="Add to Storage">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <div class="flex gap-2 mb-3">
                    <div class="w-1/2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Limit</label>
                        <select id="input-limit" class="md-input p-2 h-10">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300">300</option>
                            <option value="500">500</option>
                            <option value="0">All</option>
                        </select>
                    </div>
                    <div class="w-1/2 flex items-end">
                        <button id="btn-generate" class="w-full bg-black text-white font-bold h-10 rounded-lg active:scale-95 transition-transform text-sm">
                            GENERATE
                        </button>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div id="action-bar" class="flex justify-between items-center mb-3 hidden">
                <span class="text-xs font-bold text-gray-500" id="result-count">0 Results</span>
                <button id="btn-copy-all" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded hover:bg-blue-100">
                    <i class="far fa-copy mr-1"></i> Copy All
                </button>
            </div>

            <!-- BATCH ACTION BAR (New) -->
            <div id="batch-bar" class="hidden batch-container">
                <input type="text" id="batch-input" class="md-input text-xs h-8 py-1 flex-1" placeholder="e.g. 1-5 (range) or 1-3-5-8 (list)">
                <button onclick="applyBatchSold()" class="text-xs font-bold bg-red-100 text-red-600 px-3 py-2 rounded border border-red-200 hover:bg-red-200">
                    Mark SOLD
                </button>
            </div>

            <!-- Results List -->
            <div id="results-list" class="flex flex-col gap-2 pb-10">
                <div class="text-center text-gray-400 text-xs mt-10">
                    Enter an email to generate combinations.
                </div>
            </div>

        </main>

        <!-- DATA MODAL -->
        <div id="data-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Smart Protection</h3>
                    <button id="btn-close-data" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="space-y-3">
                    <div class="text-xs text-gray-500 mb-2">
                        Your data is automatically saved to this browser. Use Export/Import to move data to another device.
                    </div>

                    <button onclick="exportBackup()" class="w-full bg-black text-white font-bold py-3 rounded text-sm flex justify-center items-center gap-2">
                        <i class="fas fa-download"></i> Export Data File
                    </button>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-200"></div>
                        </div>
                        <div class="relative flex justify-center text-xs">
                            <span class="px-2 bg-white text-gray-500">OR</span>
                        </div>
                    </div>

                    <div>
                        <input type="file" id="file-import" class="hidden" accept=".txt,.json">
                        <button onclick="document.getElementById('file-import').click()" class="w-full border border-gray-300 text-gray-700 font-bold py-2 rounded text-xs mb-2 hover:bg-gray-50">
                            Select File to Import
                        </button>
                        <textarea id="import-text" class="w-full border p-2 text-[10px] rounded mb-2 font-mono h-20" placeholder="Paste import code here..."></textarea>
                        <button onclick="processImport()" class="w-full bg-blue-600 text-white font-bold py-2 rounded text-xs mb-4">
                            Import Data
                        </button>
                    </div>

                    <div class="border-t border-gray-200 pt-3">
                        <button onclick="resetData()" class="w-full text-red-500 font-bold py-2 rounded text-xs border border-red-200 hover:bg-red-50">
                            <i class="fas fa-trash-alt mr-1"></i> Reset All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMAIL STORAGE MODAL -->
        <div id="storage-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg"><i class="fas fa-folder mr-2 text-blue-500"></i>Saved Emails</h3>
                    <button id="btn-close-storage" class="text-gray-400 hover:text-black"><i class="fas fa-times"></i></button>
                </div>
                <div id="saved-emails-list" class="max-h-60 overflow-y-auto border border-gray-100 rounded mb-2">
                    <p class="text-center text-gray-400 text-xs py-4">No saved emails.</p>
                </div>
                <p class="text-[10px] text-gray-400 text-center">Click an email to load it</p>
            </div>
        </div>

    </div>

    <script>
        // --- Dark Mode Init ---
        const btnTheme = document.getElementById('btn-theme');
        if (document.documentElement.classList.contains('dark-mode')) {
            btnTheme.innerHTML = '<i class="fas fa-sun"></i>';
        }
        btnTheme.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark-mode');
            const isDark = document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('shein_pcal_theme', isDark ? 'dark' : 'light');
            btnTheme.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        });

        // --- Logic ---
        const inputEmail = document.getElementById('input-email');
        const inputLimit = document.getElementById('input-limit');
        const btnGenerate = document.getElementById('btn-generate');
        const resultsList = document.getElementById('results-list');
        const actionBar = document.getElementById('action-bar');
        const batchBar = document.getElementById('batch-bar'); 
        const resultCount = document.getElementById('result-count');
        const btnCopyAll = document.getElementById('btn-copy-all');
        const batchInput = document.getElementById('batch-input');
        
        // Data Modal
        const btnData = document.getElementById('btn-data');
        const dataModal = document.getElementById('data-modal');
        const btnCloseData = document.getElementById('btn-close-data');
        const fileImport = document.getElementById('file-import');
        const importTextArea = document.getElementById('import-text');

        // Storage Modal
        const btnOpenStorage = document.getElementById('btn-open-storage');
        const btnSaveEmail = document.getElementById('btn-save-email');
        const storageModal = document.getElementById('storage-modal');
        const btnCloseStorage = document.getElementById('btn-close-storage');
        const savedEmailsList = document.getElementById('saved-emails-list');

        // Database & Session
        let db = JSON.parse(localStorage.getItem('maildot_db') || '{}');
        let session = JSON.parse(localStorage.getItem('maildot_session') || '{}');
        let savedEmails = JSON.parse(localStorage.getItem('maildot_saved_emails') || '[]');
        let currentEmails = []; // Store current generated list for batch ops

        // Stats Elements
        const elStatToday = document.getElementById('stat-today');
        const elStatAccounts = document.getElementById('stat-accounts');
        const elStatWeek = document.getElementById('stat-week');
        const elStatTotal = document.getElementById('stat-total');

        // --- Initialization ---
        // Restore Session
        if (session.email) {
            inputEmail.value = session.email;
            inputLimit.value = session.limit || "50";
            setTimeout(() => btnGenerate.click(), 100);
        }
        updateStats();

        // --- Event Listeners ---
        inputEmail.addEventListener('input', saveSession);
        inputLimit.addEventListener('change', saveSession);

        btnGenerate.addEventListener('click', () => {
            const email = inputEmail.value.trim();
            if (!email.includes('@')) { alert('Invalid Email'); return; }

            saveSession();
            const limitVal = parseInt(inputLimit.value);
            let combos = getCombinations(email);
            const totalPossible = combos.length;

            if (limitVal > 0 && combos.length > limitVal) {
                combos = combos.slice(0, limitVal);
            }
            
            currentEmails = combos; // Save for batch access
            renderList(combos, totalPossible);
        });

        // Batch Action
        window.applyBatchSold = function() {
            const val = batchInput.value.trim();
            if (!val) return;
            
            let indices = new Set();
            
            // Normalize dashes
            const normalized = val.replace(/-+/g, '-');
            
            // Check heuristic: 
            // If strictly numbers and dashes (no commas), we interpret based on count
            if (/^[\d-]+$/.test(normalized) && !normalized.includes(',')) {
                const parts = normalized.split('-').filter(s => s);
                if (parts.length === 2) {
                    // Assume Range 1-5
                    const start = parseInt(parts[0]);
                    const end = parseInt(parts[1]);
                    if (start <= end) {
                        for(let i=start; i<=end; i++) indices.add(i);
                    }
                } else {
                    // Assume List 1-3-5-8
                    parts.forEach(p => indices.add(parseInt(p)));
                }
            } else {
                // Fallback to standard parsing (commas for list, dash for range)
                const segments = val.split(/[,\s]+/);
                segments.forEach(seg => {
                    if (seg.includes('-')) {
                        const rangeParts = seg.split('-');
                        if (rangeParts.length === 2) {
                            const start = parseInt(rangeParts[0]);
                            const end = parseInt(rangeParts[1]);
                            if (!isNaN(start) && !isNaN(end) && start <= end) {
                                for(let i=start; i<=end; i++) indices.add(i);
                            }
                        }
                    } else {
                        const num = parseInt(seg);
                        if (!isNaN(num)) indices.add(num);
                    }
                });
            }
            
            if (indices.size === 0) { alert("No valid numbers found."); return; }
            
            if (!confirm(`Mark ${indices.size} emails as SOLD?`)) return;
            
            indices.forEach(idx => {
                // 1-based index to 0-based
                const emailIndex = idx - 1;
                if (emailIndex >= 0 && emailIndex < currentEmails.length) {
                    const email = currentEmails[emailIndex];
                    saveData(email, 'status', 'sold');
                }
            });
            
            // Refresh view
            const total = (inputLimit.value === '0' || getCombinations(inputEmail.value).length <= parseInt(inputLimit.value)) 
                          ? currentEmails.length 
                          : getCombinations(inputEmail.value).length;
                          
            renderList(currentEmails, total);
            batchInput.value = '';
        }

        // Data Management Events
        btnData.addEventListener('click', () => dataModal.classList.add('show'));
        btnCloseData.addEventListener('click', () => dataModal.classList.remove('show'));
        
        fileImport.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                importTextArea.value = e.target.result;
                processImport();
            };
            reader.readAsText(file);
        });

        // Storage Events
        btnOpenStorage.addEventListener('click', () => {
            renderSavedEmails();
            storageModal.classList.add('show');
        });
        btnCloseStorage.addEventListener('click', () => storageModal.classList.remove('show'));
        
        btnSaveEmail.addEventListener('click', () => {
            const email = inputEmail.value.trim();
            if (!email || !email.includes('@')) { alert("Please enter a valid email to save."); return; }
            if (savedEmails.includes(email)) { alert("Email already saved."); return; }
            
            savedEmails.push(email);
            localStorage.setItem('maildot_saved_emails', JSON.stringify(savedEmails));
            alert("Email saved to storage.");
        });

        // --- Functions ---

        function saveSession() {
            const s = {
                email: inputEmail.value,
                limit: inputLimit.value
            };
            localStorage.setItem('maildot_session', JSON.stringify(s));
        }

        function updateStats() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay())).getTime();
            const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();

            let today = 0, week = 0, month = 0, total = 0, count = 0;

            Object.values(db).forEach(item => {
                count++;
                if (item.status === 'sold' && item.price) {
                    const price = parseFloat(item.price);
                    const ts = item.timestamp;
                    if (ts >= todayStart) today += price;
                    if (ts >= weekStart) week += price;
                    if (ts >= monthStart) month += price;
                    total += price;
                }
            });

            elStatToday.innerText = '₱' + today.toLocaleString();
            elStatWeek.innerText = '₱' + week.toLocaleString();
            elStatTotal.innerText = '₱' + total.toLocaleString();
            elStatAccounts.innerText = count;
        }

        function saveData(email, field, value) {
            // Initialize with UNUSED as default
            if (!db[email]) {
                db[email] = { price: '', note: '', status: 'unused', timestamp: Date.now(), copied: false };
            }
            db[email][field] = value;
            if (field === 'price' && value !== '' && db[email].status === 'unused') {
                db[email].status = 'active';
            }
            if (field === 'status' && value === 'sold') {
                db[email].timestamp = Date.now();
            }
            localStorage.setItem('maildot_db', JSON.stringify(db));
            updateStats();
            
            if (field === 'price') {
                const btn = document.querySelector(`button[data-email="${email}"]`);
                if (btn && db[email].status === 'active') {
                    btn.innerText = 'ACTIVE';
                    btn.className = 'status-btn status-active';
                }
            }
        }

        function getCombinations(email) {
            const [user, domain] = email.split('@');
            if (!user || !domain) return [];
            const n = user.length - 1;
            const max = 1 << n;
            const combos = [];
            const safeMax = n > 15 ? 10000 : max; 
            for (let i = 0; i < safeMax; i++) {
                let str = user[0];
                for (let j = 0; j < n; j++) {
                    if ((i >> j) & 1) str += '.';
                    str += user[j + 1];
                }
                combos.push(str + '@' + domain);
            }
            return combos;
        }

        function renderList(emails, totalCount) {
            resultsList.innerHTML = '';
            if (emails.length === 0) return;

            actionBar.classList.remove('hidden');
            batchBar.classList.remove('hidden'); // Show batch bar
            
            if (totalCount && totalCount > emails.length) {
                resultCount.innerText = `${emails.length} Shown / ${totalCount.toLocaleString()} Total`;
            } else {
                resultCount.innerText = `${emails.length.toLocaleString()} Results`;
            }

            emails.forEach((email, index) => { // Added index
                const saved = db[email] || { price: '', note: '', status: 'unused', copied: false };
                const status = saved.status || 'unused'; 
                const isCopied = saved.copied === true;
                const isSold = status === 'sold';

                const div = document.createElement('div');
                div.className = 'email-item';
                
                let statusClass = 'status-unused';
                let statusText = 'UNUSED';
                if (status === 'active') { statusClass = 'status-active'; statusText = 'ACTIVE'; }
                if (status === 'sold') { statusClass = 'status-sold'; statusText = 'SOLD'; }

                let textClass = 'email-text';
                if (isSold) textClass += ' sold';
                else if (isCopied) textClass += ' copied';

                let iconButton = '';
                if (isSold) {
                    iconButton = `<button class="copy-btn-icon locked" title="Sold (Locked)"><i class="fas fa-times"></i></button>`;
                } else {
                    iconButton = `<button class="copy-btn-icon" onclick="copyText(this, '${email}')" title="Copy Email"><i class="far fa-copy"></i></button>`;
                }

                div.innerHTML = `
                    <div class="email-row">
                        <span class="row-number">#${index + 1}</span> <!-- Added Number -->
                        <span class="${textClass}" id="txt-${email}">${email}</span>
                        ${iconButton}
                    </div>
                    <div class="item-controls">
                        <div class="relative w-1/4">
                            <span class="absolute left-1.5 top-1.5 text-xs text-gray-400">₱</span>
                            <input type="number" class="tiny-input w-full pl-4" placeholder="Price" 
                                value="${saved.price}" onchange="saveData('${email}', 'price', this.value)">
                        </div>
                        <input type="text" class="tiny-input flex-1" maxlength="16" placeholder="Note (16 chars)" 
                            value="${saved.note}" onchange="saveData('${email}', 'note', this.value)">
                        <button class="status-btn ${statusClass}" data-email="${email}"
                            onclick="toggleStatus(this, '${email}')">
                            ${statusText}
                        </button>
                    </div>
                `;
                resultsList.appendChild(div);
            });
        }

        function renderSavedEmails() {
            if (savedEmails.length === 0) {
                savedEmailsList.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">No saved emails.</p>';
                return;
            }
            savedEmailsList.innerHTML = savedEmails.map(email => `
                <div class="saved-email-row" onclick="loadSavedEmail('${email}')">
                    <span class="text-sm font-mono text-gray-600 truncate">${email}</span>
                    <button onclick="event.stopPropagation(); deleteSavedEmail('${email}')" class="text-gray-400 hover:text-red-500 p-1">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        window.loadSavedEmail = function(email) {
            inputEmail.value = email;
            storageModal.classList.remove('show');
            btnGenerate.click(); // Auto generate
        }

        window.deleteSavedEmail = function(email) {
            if(!confirm(`Delete ${email} from storage?`)) return;
            savedEmails = savedEmails.filter(e => e !== email);
            localStorage.setItem('maildot_saved_emails', JSON.stringify(savedEmails));
            renderSavedEmails();
        }

        window.copyText = function(btn, text) {
            navigator.clipboard.writeText(text).then(() => {
                saveData(text, 'copied', true);
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                const textEl = document.getElementById(`txt-${text}`);
                if(textEl) textEl.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 1500);
            });
        }

        window.toggleStatus = function(btn, email) {
            const currentText = btn.innerText;
            let nextStatus = 'active'; 
            if (currentText === 'UNUSED') nextStatus = 'active';
            else if (currentText === 'ACTIVE') nextStatus = 'sold';
            else if (currentText === 'SOLD') nextStatus = 'active'; 

            if (nextStatus === 'sold') {
                if (!confirm(`Mark ${email} as SOLD? This will lock the email.`)) return;
            }

            saveData(email, 'status', nextStatus);
            
            let nextClass = 'status-active';
            let nextLabel = 'ACTIVE';
            if (nextStatus === 'unused') { nextClass = 'status-unused'; nextLabel = 'UNUSED'; }
            if (nextStatus === 'sold') { nextClass = 'status-sold'; nextLabel = 'SOLD'; }
            
            btn.innerText = nextLabel;
            btn.className = `status-btn ${nextClass}`;

            const row = btn.closest('.email-item').querySelector('.email-row');
            const textEl = row.querySelector('.email-text');
            const iconContainer = row.querySelector('button');

            if (nextStatus === 'sold') {
                textEl.classList.add('sold');
                textEl.classList.remove('copied'); 
                const newBtn = document.createElement('button');
                newBtn.className = "copy-btn-icon locked";
                newBtn.title = "Sold (Locked)";
                newBtn.innerHTML = '<i class="fas fa-times"></i>';
                row.replaceChild(newBtn, iconContainer);
            } else {
                textEl.classList.remove('sold');
                const saved = db[email];
                if (saved && saved.copied) textEl.classList.add('copied');
                if (iconContainer.classList.contains('locked')) {
                    const newBtn = document.createElement('button');
                    newBtn.className = "copy-btn-icon";
                    newBtn.title = "Copy Email";
                    newBtn.onclick = function() { copyText(this, email) };
                    newBtn.innerHTML = '<i class="far fa-copy"></i>';
                    row.replaceChild(newBtn, iconContainer);
                }
            }
        }

        window.resetData = function() {
            if (confirm("WARNING: This will delete ALL generated email data (earnings, notes, statuses) and Saved Emails list. This action cannot be undone. Are you sure?")) {
                localStorage.removeItem('maildot_db');
                localStorage.removeItem('maildot_saved_emails');
                localStorage.removeItem('maildot_session');
                
                db = {};
                savedEmails = [];
                inputEmail.value = "";
                resultsList.innerHTML = '<div class="text-center text-gray-400 text-xs mt-10">Enter an email to generate combinations.</div>';
                actionBar.classList.add('hidden');
                batchBar.classList.add('hidden'); // Hide batch bar on reset
                
                updateStats();
                alert("All data and settings have been reset.");
                dataModal.classList.remove('show');
            }
        }

        btnCopyAll.addEventListener('click', () => {
            const emails = Array.from(document.querySelectorAll('.email-text')).map(e => e.innerText).join('\n');
            navigator.clipboard.writeText(emails).then(() => {
                btnCopyAll.innerHTML = '<i class="fas fa-check"></i> Copied';
                setTimeout(() => btnCopyAll.innerHTML = '<i class="far fa-copy mr-1"></i> Copy All', 2000);
                document.querySelectorAll('.email-text').forEach(el => el.classList.add('copied'));
            });
        });

        // ... Export/Import functions same as before ...
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        window.exportBackup = function() {
            try {
                const backup = { db: db, savedEmails: savedEmails };
                const dataStr = utf8_to_b64(JSON.stringify(backup));
                const blob = new Blob([dataStr], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0,10);
                a.download = `maildot_backup_${date}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch(e) { alert("Export failed: " + e.message); }
        }

        window.processImport = function() {
            const code = importTextArea.value.trim();
            if (!code) { alert("Please paste code or select a file."); return; }
            try {
                const jsonStr = b64_to_utf8(code);
                const importedData = JSON.parse(jsonStr);
                
                if (typeof importedData !== 'object') throw new Error();

                if (importedData.db) {
                    db = { ...db, ...importedData.db };
                    if (importedData.savedEmails) {
                        const newSet = new Set([...savedEmails, ...importedData.savedEmails]);
                        savedEmails = Array.from(newSet);
                        localStorage.setItem('maildot_saved_emails', JSON.stringify(savedEmails));
                    }
                } else {
                    db = { ...db, ...importedData };
                }

                localStorage.setItem('maildot_db', JSON.stringify(db));
                updateStats();
                
                if (inputEmail.value) btnGenerate.click();

                alert("Data imported successfully!");
                dataModal.classList.remove('show');
                importTextArea.value = "";
                fileImport.value = "";
            } catch (e) {
                alert("Invalid Import Code or File Format.");
            }
        }

    </script>
</body>
</html>
